<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Enhanced Media Trust Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect, useRef } = React;

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      return lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.replace(/^"|"$/g, '').trim());
        const item = {};
        headers.forEach((key, i) => {
          item[key] = key === 'value' ? parseFloat(values[i]) : values[i];
        });
        return item;
      });
    }

    function LollipopChart({ data }) {
      const chartRef = useRef(null);

      useEffect(() => {
        if (!data.length) return;

        const ctx = chartRef.current.getContext('2d');
        if (chartRef.current.chartInstance) {
          chartRef.current.chartInstance.destroy();
        }

        const countryData = {};
        data.forEach(item => {
          if (isNaN(item.value)) return;
          if (!countryData[item.country]) {
            countryData[item.country] = { total: 0, count: 0 };
          }
          countryData[item.country].total += item.value;
          countryData[item.country].count += 1;
        });

        const labels = Object.keys(countryData);
        const values = labels.map(country => {
          const { total, count } = countryData[country];
          return Math.round((total / count) * 10) / 10;
        });

        const chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              {
                label: 'Average Trust',
                data: values,
                backgroundColor: 'transparent',
                borderColor: '#2563eb',
                borderWidth: 2,
                barThickness: 4,
                datalabels: {
                  anchor: 'end',
                  align: 'end',
                  backgroundColor: '#2563eb',
                  borderRadius: 20,
                  color: '#fff',
                  padding: 6,
                  formatter: value => value,
                  font: {
                    weight: 'bold'
                  }
                }
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true },
              datalabels: {}
            },
            scales: {
              x: {
                grid: { drawBorder: false },
                ticks: { autoSkip: false }
              },
              y: {
                beginAtZero: true,
                grid: { drawBorder: false }
              }
            }
          },
          plugins: [ChartDataLabels]
        });

        chartRef.current.chartInstance = chartInstance;
      }, [data]);

      return (
        <div className="bg-white rounded shadow p-4">
          <h2 className="text-xl font-semibold mb-4">Lollipop Chart: Avg Trust by Country</h2>
          <canvas ref={chartRef} height="500"></canvas>
        </div>
      );
    }

    function EnhancedDashboard() {
      const [data, setData] = useState([]);
      const [activeTab, setActiveTab] = useState('summary');

      useEffect(() => {
        fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vSOaHJvkHYWtyNwxgrmvAg7-PfNrzdV07da9wMhjutSpFS28H8m_MMTlXp4ZGLUvs_8mCZFJb4g96jl/pub?gid=0&single=true&output=csv")
          .then(res => res.text())
          .then(text => setData(parseCSV(text)))
          .catch(err => console.error("Fetch error:", err));
      }, []);

      return (
        <div className="max-w-6xl mx-auto py-10 px-4">
          <div className="flex gap-4 mb-6">
            <button
              className={`px-4 py-2 rounded ${activeTab === 'summary' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
              onClick={() => setActiveTab('summary')}
            >
              Summary
            </button>
            <button
              className={`px-4 py-2 rounded ${activeTab === 'table' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
              onClick={() => setActiveTab('table')}
            >
              Table
            </button>
            <button
              className={`px-4 py-2 rounded ${activeTab === 'lollipop' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
              onClick={() => setActiveTab('lollipop')}
            >
              Lollipop
            </button>
          </div>

          {activeTab === 'summary' && (
            <>
              <div className="p-4 bg-white rounded shadow mb-6">Summary view placeholder</div>
              <LollipopChart data={data} />
            </>
          )}
          {activeTab === 'table' && (
            <div className="p-4 bg-white rounded shadow">
              Table view placeholder
            </div>
          )}
          {activeTab === 'lollipop' && (
            <LollipopChart data={data} />
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<EnhancedDashboard />);
  </script>
</body>
</html>
